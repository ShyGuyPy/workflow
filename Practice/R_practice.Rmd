---
title: "R practice"
author: "Luke Vawter"
date: "September 18, 2018"
output: html_document
---

factors in R:
https://swcarpentry.github.io/r-novice-inflammation/12-supp-factors/
not char or string,
they are integers and behave as such
```{r}
library(magrittr)

fruits <- factor(c("grape", "bananna", "grape", "bananna", "apple", "orange"))
#sets order of factor levels
fruits <- factor(fruits, levels = c("orange", "grape", "bananna", "apple"), ordered = TRUE)
levels(fruits)
nlevels(fruits)

fruits %>%
  trimws() %>%
  print()

```

trimws():
```{r}
library(magrittr)

thing <- " this is a test   "
print(trimws(thing))
#and again using pipes
thing %>% 
  trimws() %>%
  print()

```
playing with select, filter,     :
```{r}
library(magrittr)
library(readxl)
library(dplyr)


#creates project.dir, phyto directory object 
project.dir <- rprojroot::find_rstudio_root_file()

toy.df <- read_excel(file.path(project.dir, "data/jackie_data/Data 2013_4plus-phyto-metrics.xlsx"),
                         sheet = "DATA_4+biometrics",
                         skip = 1)

#colnames(toy.df)

new.toy.df <- toy.df %>%
  #include only those columns starting with s
  select(starts_with("s")) %>%
  
  #only include rows which fall within given ranges
  filter(SURVEY_ID <= 30867, SALINITY < 6) %>%
  #select(SURVEY_ID:SAMPLE_DATE) %>
  
  #arrange in descending order based on SURVEY_ID value
  arrange(desc(SURVEY_ID)) %>%
  print()

mutant.toy.df <- toy.df %>%
  
  mutate(nonsense=SECCHI/SALINITY) %>%
  print()
  
#also could do group_by()
```

```{r}
library(magrittr)

project.dir <- rprojroot::find_rstudio_root_file()

toy.df <- read_excel(file.path(project.dir, "data/jackie_data/Data 2013_4plus-phyto-metrics.xlsx"),
                         sheet = "DATA_4+biometrics",
                         skip = 1)

toy.df %>%
  select(PIBI_Rank) %>%
  print()


```

http://r4ds.had.co.nz/data-visualisation.html
working through "R for Data Science", a resource Zach linked.  Plenty of it I'm familiar with, but I'm finding my data scientist skills could use some work so I'm doing some review:
```{r}
library(ggplot2)
library(magrittr)
# cars.df <- ggplot2::mpg
# print(cars.df)

cars.columns.df <- ggplot2::mpg %>%
  colnames() %>%
  print()

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, color = class, shape = drv))

ggplot(data = mpg) +
  geom_point(mapping = aes(x = cyl, y = hwy, color = class, shape = drv))




```
using str_replace_all func:
```{r}
library(ggplot2)
library(magrittr)

spaces <-c("hi here", "I'm tired","need a break")
snakes <- spaces %>%
  str_replace_all(" ", "_") %>%
  print()
```

show number of rows and coumns:
```{r}
nrow(mpg)
ncol(mpg)
```

how to apply an aesthetic to the whole plot
```{r}
library(ggplot2)

ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy), color = "blue")

```

facets can be used to break the above scaterplot into separate visualizations.  In this case the data is divided by the class of the car. What we end up with is clusters of data because car class(class) and engine size(displ) are tightly related.Also, we can see distinct sections of the downward trend of the data as engine size increases, hgihtlighting the negative relationship between engine size and highway miles per gallon(hwy).:
```{r}
library(ggplot2)


ggplot(data = mpg)+
  geom_point(mapping = aes(x=displ, y = hwy))+
  facet_wrap(~class, nrow = 2)

```


adding more than one geom:
```{r}
library(ggplot2)

ggplot(data = mpg)+
  geom_smooth(mapping = aes(x=displ, y= hwy,linetype=drv, color=drv))+
  geom_point(mapping = aes(x=displ, y= hwy, color=drv))
```

gloabl geom plotting:
```{r}
ggplot(data=mpg, mapping = aes(x=displ,y=hwy))+
  geom_line(color="blue")+
  geom_point(mapping =aes(color = class))+
  geom_smooth()
  
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy, color = drv)) + 
  geom_point() + 
  geom_smooth(se=FALSE)
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy))+
  geom_point(mapping=aes(color=drv))+
  geom_smooth(mapping=aes(linetype=drv),se=FALSE)+
  coord_flip()
```

summary I don't fully get or see the value of but here it is:
```{r}
library(ggplot2)
ggplot(data= mpg)+
  stat_summary(
    mapping = aes(x = displ, y = hwy),
    fun.ymin = min,
    fun.ymax = max,
    fun.y = median
  )
```


position values of identity, dodge, and fill(below) alter the presentation of the data:
```{r}
ggplot(data = diamonds, mapping = aes(x=cut, fill = clarity))+
  geom_bar(alpha = 3/5, position= "fill" )
```

The use of jitter in a scatterplot fixes the problem of overplotting cuased by rounding of values.  Here we can see the clustering various points(such as position 4.7, 5 or 2.8,20).  The desnity of the blob gies us a sense of how many points land at approximately the same axis point
```{r}
ggplot(data=mpg)+
  geom_point(mapping=aes(x=displ,y=hwy), position ="jitter")
```

coxcomb chart:
```{r}
library(ggplot2)

assigned <- ggplot(data=mpg, mapping = aes(x=drv, fill =drv))+
  geom_bar(width=1)+
  theme(aspect.ratio = 1)+
  labs(x = NULL, y =NULL)


assigned + coord_polar() #+ coord_flip()
  
```

"The grammar of graphics is based on the insight that you can uniquely describe any plot as a combination of a dataset, a geom, a set of mappings, a stat, a position adjustment, a coordinate system, and a faceting scheme."


```{r}
graph_components <- c("dataset", "geom", "set of mappings", "a stat", "postion", "coordinate system", "faceting scheme" )


# for (component in graph_components){
#   print(component)
# }
```

some basic R,; seq() is a function that constructs a sequence between(inclusive) the two numbers passed to it:
```{r}
seq(1,25)
```

dplyr exercises and I need the practice:
```{r}
library(nycflights13)
library(tidyverse)

#wrapped in () to both print and assign to variable
(my_flight_data <- flights %>%
  #only showing rows where dep_delay value is greater than 20
  filter(dep_delay < -20) %>%
  #only showing columns cep_delay and arr_time
  select(dep_delay,arr_time))
  #something else
  
  
```

dealing with NA values.  is.na() can be used to reference such values:
```{r}
things.df <- tibble(stuff = c(NA,2,NA))

things.df %>%
  filter(is.na(things.df) | things.df<3)

```

playing with for loops:
```{r}
library(tidyverse)
library(dplyr)
date <- "1/1/1"

id_df <- c(1,2,3)
date_df <- c("1/1/1","2/2/2","3/3/3")
value_df <- c(12,18,10)
data.df <- data.frame(id_df,date_df, value_df)
print(data.df)

for (i in 2:nrow(data.df)){
  case_when(
    date_df[i] != "1/1/1" ~ print(paste0("nope ", value_df[i])),
    date_df[i] == "1/1/1" ~ print(paste0("yep ", value_df[i]))#"yep")
  )
}

  
             
             
```
I think the above code has an issue with how I constructed the dataframe.  Will revisit but it's not my primary issue atm.

```{r}
library(readxl)

path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
my_data_p = read.csv(path_p)

#print(my_data_p)
#print(nrow(my_data_p))
mystery <- {
for(i in my_data_p$date){
  
  #print(i)
  if(as.character(i) == "1998-10-06"){print(my_data_p$p_percent_normal[which(my_data_p$date == i)])}#print(my_data_p$p_percent_normal[4])}
 
  
  

   #print(my_data_p[[i]])
}}

```

convert date format:
```{r}
#convert from "10/1/1998" to "1998/10/01"
#date <- "10/1/1998"
date <- "5/5/1981"
month="-"
day="-"
#day_single="-0"
year =""

#iterates over string date
for(i in strsplit(date,"")[[1]]){ 
  #for single digit month values
  if (i == "/" && nchar(month) <3){month <- paste0(substring(month, 1, 1), 0, substring(month,2,2))}
  #adds value to month until month has enough characters
  if (i != "/" && nchar(month) < 3) {month <- paste0(month,i)}


  
  #adds value to day until day is long enough
  else if (i != "/" && nchar(day) <3) {day <- paste0(day,i)}
  #adds a 0 in front of day value if day is only one digit
  else if (i == "/" && nchar(month) ==3 && nchar(day) >1 && nchar(day) <3) {day <- paste0(substring(day, 1, 1), 0, substring(day,2,2))}#day <- paste0(day_single,day[2])}
  #adds value to years until it is long enough
  else if (i != "/" && nchar(day) ==3 && nchar(month) == 3 && nchar(year)<4){year<- paste0(year,i)}
  
  #else if (i == "/"){}
  # case_when(
  #   i != "/"~print("no tilde"),
  #   i == "1"~print("bingo")
#date2 <- paste0(year,month,day)
#)
}
date2 <- paste0(year,month,day)
print(date2)
```
and it works. now to add it to shiny_test_app2
...and realize I've written it to convert in reverse...
so the other way now:


```{r}
#convert from "1998-10-01" to "10/1/1998"
date <- "1990-05-17"
#date <- paste0(date,"-")
month=""
day="/"
day_single= FALSE
month_single=FALSE
year ="/"

#iterates over string date
for(i in strsplit(date,"")[[1]]){
  
  if (i != "-" && nchar(year) < 5){year<- paste0(year,i)}
  
  else if (i == "0" && nchar(month) <1){month_single = TRUE}
  else if (i != "-" && nchar(month) <1){month <- paste0(month,i)}
  else if (i != "-" && nchar(month) <2 && month_single == FALSE){month <- paste0(month,i)}
  
  else if (i == "0" && nchar(day) <2) {day_single = TRUE}
  else if (i != "-" && nchar(day) <2) {day <- paste0(day,i)}
  else if (i != "-" && nchar(day) <3 && day_single == FALSE) {day <- paste0(day,i)}

}
date2 <- paste0(month,day, year)
print(date2)
```

bug checking:
```{r}
library(readxl)
library(dplyr)


#grabs data
path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
my_data_p = read.csv(path_p, stringsAsFactors = FALSE)

#converts date format
date_func <- function(date){
  date <- as.character(date)
  date <- paste0("",date,"")
  month=""
  day="/"
  day_single= FALSE
  month_single=FALSE
  year ="/"
  
  #iterates over string date
  for(i in strsplit(date,"")[[1]]){
    
    if (i != "-" && nchar(year) < 5){year<- paste0(year,i)}
    
    else if (i == "0" && nchar(month) <1){month_single = TRUE}
    else if (i != "-" && nchar(month) <1){month <- paste0(month,i)}
    else if (i != "-" && nchar(month) <2 && month_single == FALSE){month <- paste0(month,i)}
    
    else if (i == "0" && nchar(day) <2) {day_single = TRUE}
    else if (i != "-" && nchar(day) <2) {day <- paste0(day,i)}
    else if (i != "-" && nchar(day) <3 && day_single == FALSE) {day <- paste0(day,i)}
    
  }
  date <- paste0(month,day, year)
  return(date)
}

test_date = 1998-10-04
print(date_func(test_date))

p_data_percent <-
for(i in my_data_p$date){

                    case_when(
                   as.character(i) == as.character( date_func(1998-10-04))
                      ~"good"#my_data_p$p_percent_normal[which(my_data_p$date == i)]
                    )
  
}

print(p_data_percent)
print(my_data_p$p_percent_normal[which(my_data_p$date == "1998-10-04")])

# for(i in my_data_p$date){
#   
#   #print(i)
#   if(as.character(i) == "1998-10-04"){print(my_data_p$p_percent_normal[which(my_data_p$date == i)])}#print(my_data_p$p_percent_normal[4])}
```


```{r}
library(readxl)
library(dplyr)


#grabs data
path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
my_data_p = read.csv(path_p)

# for(i in my_data_p$p_percent_normal){
#   print(typeof(i))
# }

# for(i in my_data_p$date){
#   print(typeof(i))
# }
```

```{r}
thing0 <- 1-2-3 
thing <- as.character(1-2-3)
thing2 <- "1-2-3"
thing3 <- as.double(1-2-3)

print(nchar(thing))
print(nchar(thing2))
print(thing)
print(thing0)
print(thing3)

```

R is running date values with "-" as math operations

Interesting...but discontinuing because a different approach is needed for integration into 2018DEX.

r for Data Science 5.3, 5.4:
```{r}
library(dplyr)

path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
                if( .Platform$OS.type == "unix" ) {
                  path_p <- "/Users/lukevawter/Desktop/R/2018drex/input/ts/state/i_a1b/va_shenandoah_p.csv"
                }
my_data_p = data.table::fread(path_p)
print(my_data_p)


mdp_trimmed <- my_data_p %>%
  #arrange(my_data_p$p_percent_normal) %>%
  select(-date) %>%
  select(-V3,-V4)

  
mdp_trimmed %>%
  transmute(double = my_data_p$p_percent_normal * 2) %>%
  mutate(triple = my_data_p$p_percent_normal * 3)

  


```


```{r}
library(nycflights13)

flights_sml <- select(flights,
                      year:day,
                      ends_with("delay"),
                      distance,
                      air_time
                      )

flights_mut <- flights_sml %>%
  mutate(gain = dep_delay - arr_delay,
       speed = distance / air_time * 60)

flights_mut %>%
  select(gain, speed)
```

R for Data Science 5.5:
```{r}
library(nycflights13)

flights %>%
  transmute(dep_time, hour = dep_time %/% 100,
            minutes = dep_time %% 100)
```

and a bit of python review just because I feel like I'm getting rusty:
```{python}
test_var = 517 

remains_2= test_var % 100
remains_1= (test_var - remains_2) / 100
print("{}:{}".format(remains_1,remains_2))
```

R for Data Science 5.6 using summarise():
```{r}
library(nycflights13)

by_day <- flights %>%
  group_by(year, month, day) #%>%

by_day %>%
  summarise( delay = mean(dep_delay, na.rm=TRUE))

# by_day <- group_by(flights, year, month, day)
# summarise(by_day, delay = mean(dep_delay, na.rm = TRUE))
```
na.rm overrieds the rule that any input with missing values will generate a missing value(NA).  If we don't want those NA's in our output we include na.rm in summarise.

```{r}
library(ggplot2)

not_cancelled <- flights %>% 
  filter(!is.na(dep_delay), !is.na(arr_delay))

delays <- not_cancelled %>% 
  group_by(tailnum) %>% 
  summarise(
    delay = mean(arr_delay, na.rm = TRUE),
    n = n()
  )

ggplot(data = delays, mapping = aes(x = n, y = delay)) + 
  geom_point(alpha = 1/10)

delays %>% 
  filter(n > 20) %>% 
  ggplot(mapping = aes(x = n, y = delay)) + 
    geom_point(alpha = 1/10)

```



```{r}
library(readxl)

path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
my_data_p = read.csv(path_p)

#print(my_data_p)
#print(nrow(my_data_p))
cake = "hello"
for(i in my_data_p$date){
  if(as.character(i) == "1998-10-04"){cake<-my_data_p$p_percent_normal[which(my_data_p$date == i)]}#print(my_data_p$p_percent_normal[4])}
}
print(cake) 
print(typeof(cake))
  

   #print(my_data_p[[i]])

```

```{r}
library(shiny)
path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
my_data_p = read.csv(path_p)

p_data_percent <- eventReactive(test_date$test_date_value, {
  for(i in my_data_p$date){
    case_when(
      as.character(i) == as.character(test_date$test_date_value)~ my_data_p$p_percent_normal[which(my_data_p$date == i)])
                    
                  }})

                
precip_value<-eventReactive(test_date$test_date_value,{#a_index,{
                case_when(
                  p_data_percent() <= .0 ~ "background-color:purple", #"#000000",
                  p_data_percent() > .0 && p_data_percent() <= .20 ~ red,#"background-color:red", #"#cc3300",
                  p_data_percent() > .20 && p_data_percent() <= .40 ~ orange,#"background-color:orange",  #"#ff9966",
                  p_data_percent() > .40 && p_data_percent() <= .60 ~ yellow,#"background-color:yellow",  #"#ffcc00",
                  p_data_percent() > .60 && p_data_percent() <= .80 ~ green,#"background-color:green", #"#99cc33",
                  p_data_percent() > .80 && p_data_percent() < 1 ~  navy, #"background-color:navy" #"#339900"
                  TRUE ~ black
                )})

print(p_data_percent)
print(precip_value)
```


```{r}
library(readxl)

path_p <- "C:\\Users\\icprbadmin\\Documents\\R\\2018drex\\input\\ts\\state\\i_a1b\\va_shenandoah_p.csv"
my_data_p = read.csv(path_p)


find_date <- function(col_date, col_val ){
for(i in col_date){
  if(as.character(i) == "1998-10-06"){our_value <- (col_val[which(col_date == i)])}
}
  return(our_value)}

print(find_date(my_data_p$date, my_data_p$p_percent_normal))
```

```{r}
nums <- c(1,2,3)

(2 %in% nums)
(4 %in% nums)
```

```{r}
library(magrittr)
library(dplyr)
project.dir <- rprojroot::find_rstudio_root_file()

col.class.vec <- c("samplenumber" = "character",
                   "tsn" = "character",
                   "speccode" = "character")

taxa.raw <- data.table::fread(file.path(project.dir, "data/phytoplankton/cedr_phyto_taxa.csv"),
                            data.table = FALSE,
                            colClasses = col.class.vec,
                            na.strings = "") %>% 
  mutate(sampledate = as.Date(sampledate))

bay.df <- taxa.raw %>% 
  filter(layer %in% c("ap", "wc")) %>% 
  distinct() %>% 
  mutate(month = month(sampledate),
         season = case_when(
           month %in% c(3, 4, 5) ~ "spring",
           month %in% c(7, 8, 9) ~ "summer",
           TRUE ~ "remove"
         )) %>% 
  filter(season %in% c("spring", "summer"))
```

this is how rename works(requires plyr apparently):
```{r}
library(dplyr)
library(plyr)

my_vec <- c("a" = 1, "b" = 2, "c" = 4)
my_vec

my_vec <- rename(my_vec, c("a"="alpha","b"="bravo","c"="charlie"))
my_vec

```

````{r}
library(magrittr)
library(dplyr)
library(ggplot2)

clean_string <- function(x) {
  x %>% 
    stringr::str_trim() %>% 
    tolower() %>% 
    stringr::str_replace_all("\\s+", " ") %>% 
    stringr::str_replace_all(" ", "_") %>%  
    if_else(. == "", as.character(NA), .)
}

clean_up <- function(x) {
  x %>% 
    rename_all(clean_string) %>% 
    mutate_if(is.character, funs(clean_string))%>% 
    distinct()
}

project.dir <- rprojroot::find_rstudio_root_file()

old.salzone <- readxl::read_excel(file.path(project.dir, "data/jackie_data/JMJ_PIBI_Salzone_Data.xlsx"),
                                  sheet = "DataHub_Phytoplankton_Events_22")#was "JMJ Salzone+Scores"
colnames(old.salzone)

clean_zone <- clean_up(old.salzone) 

ggplot(data = clean_zone, mapping = aes(x = totaldepth, color= salzone)) +
  geom_freqpoly(binwidth = 1, na.rm = TRUE )

ggplot(data=clean_zone, mapping = aes(x = totaldepth, color= pdepth))+
  geom_histogram(binwidth = 1, na.rm = TRUE )#+
  #coord_cartesian(ylim= c(0,200))  #used to zoom in

explore_val <- clean_zone %>%
  filter(totaldepth > 33 | totaldepth <2) %>%
  select(sampletime, longitude, latitude, salzone)
  #select()
rare_val

#as far as I know these are not values that should be excluded in this way.  I'm only using them for practice
clean_zone.nona <- clean_zone %>%
  mutate(totaldepth = ifelse(totaldepth<2 | totaldepth>33, NA, totaldepth)) %>%
  arrange(totaldepth) 

print(clean_zone.nona %>%
  select(totaldepth))
  
```


```{r}
library(readxl)
library(dplyr)

my_data_p <-data.table::fread(paste("test_data.csv", sep = ""))
print(head(my_data_p,2))
print(typeof(my_data_p$date[1]))
print(typeof(my_data_p$date[2]))

```

R for Data science 7.5 plus incorporating some of Zach's phyto code:
```{r}
library(magrittr)
library(dplyr)
library(ggplot2)

clean_string <- function(x) {
  x %>% 
    stringr::str_trim() %>% 
    tolower() %>% 
    stringr::str_replace_all("\\s+", " ") %>% 
    stringr::str_replace_all(" ", "_") %>%  
    if_else(. == "", as.character(NA), .)
}

clean_up <- function(x) {
  x %>% 
    rename_all(clean_string) %>% 
    mutate_if(is.character, funs(clean_string))%>% 
    distinct()
}

project.dir <- rprojroot::find_rstudio_root_file()

old.salzone <- readxl::read_excel(file.path(project.dir, "data/jackie_data/JMJ_PIBI_Salzone_Data.xlsx"),
                                  sheet = "DataHub_Phytoplankton_Events_22")#was "JMJ

colnames(old.salzone)

clean_zone <- clean_up(old.salzone) 

print(tail(clean_zone,2))
print(clean_zone[1,5])

zone.vec <- sort(unique(clean_zone$salzone))
min.zone <- zone.vec[1]
max.zone <- zone.vec[length(zone.vec)]

ggplot(data=clean_zone, mapping = aes(salzone, totaldepth)) +
  scale_y_continuous(limits = c(0,35))+
  annotate("rect", xmin=min.zone, xmax=max.zone, ymin =0, ymax = 10,fill= "red", alpha=.25)+
  annotate("rect", xmin=min.zone, xmax=max.zone, ymin =10, ymax =25 ,fill= "yellow", alpha=.25)+
  annotate("rect", xmin=min.zone, xmax=max.zone, ymin =25, ymax = 35,fill= "green", alpha=.25)+
  geom_boxplot()
```



```{r}
library(readxl)
library(dplyr)


my_data_p <-data.table::fread(paste("handmade_test_data.csv", sep = ""))
print(head(my_data_p,6))
print(typeof(my_data_p$date[1]))
print(typeof(my_data_p$date[2]))


todays_date = "10/5/1998"#"1998-10-05"


date_func <- function(col_date, col_val, date_today ){
  our_value <- 0
  for(i in col_date){
    if(i == as.character(date_today)){our_value <- (col_val[which(col_date == i)])}
  }
  return(our_value)}

date_func(my_data_p$date, my_data_p$p_percent_normal, todays_date)

```

```{r}
library(dplyr)

df = read.csv("./cedr_phyto_station.csv", stringsAsFactors = F)
print(df$latitude)

df$latitude <- as.numeric(df$latitude)
df$longitude <- as.numeric(df$longitude)
```


```{r}
library(magrittr)
library(ggplot2)

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, color = class, shape = drv))+
  coord_cartesian(xlim =c(5, 20), ylim = c(0, 50))
```

use of str_detect:
```{r}
#required pacakge fro using str_detect
library(stringr)

my_str <- "orangeapplebananna"
str_detect(my_str, "apple")
str_detect(my_str, "pear")

```

```{r}
elements.vec <- c(1,2,3,8)
current.vec <- c(2,4,5,6)

if(any(!nums %in% unique(nums2))) {print(nums[!nums %in% unique(nums2)])}
#if(any(!nums %in% nums2)){print(!nums)}



```

```{r}
library(stringr)
p = "today's date is"
m = "10/10/1910"
#str_c(p,m, sep= " ")
str_pad(str_c("today's date is",m, sep= " "), width = 30, side = "right", pad= " ")


```



12/3/18
some dplyr practice for future work on phyto, chessie_bibi and mmir
https://www.youtube.com/watch?v=jWjqLW-u3hc
```{r}
library(dplyr)
library(readxl)
library(data.table)

project.dir <- rprojroot::find_rstudio_root_file()

print(project.dir)


phyto_practice.df <- data.table::fread(file.path(project.dir, 
                                                 "data/phytoplankton2/VA_ODU_phyto_event.csv"),
                            data.table = FALSE,
                            #colClasses = col.class.vec,
                            na.strings = "")

pp.df <- phyto_practice.df

pp.df %>%
  tally(sort=TRUE)

pp_changed.df <- pp.df %>%
  select(pdepth, totaldepth) %>%
  arrange(desc(pdepth)) %>%
  mutate(deep_p = pdepth >=20)

#https://www.youtube.com/watch?v=f0U74ZvLfQo

# make the item at row 2 column 2 NA
pp_changed.df[2,2]<-NA

final.df <- pp_changed.df%>%
  summarize(measurevalue = mean(pdepth, na.rm=TRUE))


```



https://www.datacamp.com/community/tutorials/r-tutorial-apply-family
```{r}
apple <- matrix(rnorm(18), nrow = 3, ncol = 6)
#print(apple)


#to apply mean calculation to each set of column values
apply(apple, 2, mean)

#to apply mean calculation to each set of row values
apply(apple, 1, mean)

#trimmed <- apply(apple[,-c(1,2)],2,mean)
```

to test RET,TF,LE station issue fix
```{r}
library(dplyr)
library(readxl)
library(data.table)

project.dir <- rprojroot::find_rstudio_root_file()

events_test.df <- data.table::fread(file.path(project.dir, 
                                                 "data/phytoplankton2/VA_ODU_phyto_event.csv"),
                            data.table = FALSE,
                            #colClasses = col.class.vec,
                            na.strings = "")

stations_test.df <- events_test.df %>%
  select(station) %>%
  distinct()

events_test.df <- events_test.df%>%

mutate(salzone_test = case_when(
    events_test.df$station %in% c("tf3.3","tf4.2","tf5.5")~ "F",
    #events_test.df$station == starts_with("cb")~ "good",
    events_test.df$station %in% c("ret3.1","ret4.3","ret3.1")~ "O",
    events_test.df$station %in% c("le3.6","le5.2","le5.4","le5.5-w")~ "P",
    TRUE~"bogus"

  )
  )

    

```

```{r}
library(dplyr)
library(readxl)
library(data.table)

project.dir <- rprojroot::find_rstudio_root_file()

taxa.df <- data.table::fread(file.path(project.dir, 
                                                 "data/phytoplankton2/VA_ODU_phyto_taxa.csv"),
                            data.table = FALSE,
                            #colClasses = col.class.vec,
                            na.strings = "")



id <- c(1,2,3)
date <- c("1/1/1","2/2/2","3/3/3")
name <- c("ted","fred", "dave")
value <- c(12,5,10)
data.df <- data.frame(id, date, value, name)

n.df <- data.df%>%
  group_by_at(vars(-value)) %>% 
  summarise(value=mean(value)) %>%
  ungroup()


#count(data.df$name == 23)

test.df <- data.df %>% 
  group_by_at(vars(-value)) %>%
  summarize(value = sum(value)) %>%
  ungroup()

find.df <- data.df %>%
  filter(grepl("ed", name))

# test2.df <- taxa.df %>% 
#   group_by_at(vars(-reportingvalue)) #%>%
  # summarize(reportingvalue2 = sum(reportingvalue)) %>%
  # ungroup()


```


this is salzone calculation but without 3 day
```{r}
library(dplyr)
library(readxl)
library(data.table)
library(tidyr)

project.dir <- rprojroot::find_rstudio_root_file()
wq.raw <- data.table::fread(file.path(project.dir, "data/water_quality/cedr_wq.csv"),
                            data.table = FALSE,
                           na.strings = c("")) %>% 
  filter(is.na(problem),
         parameter %in% c("chla", "doc", "pheo", "salinity"))

wq.df <- wq.raw %>% 
  mutate(sampledate = as.Date(sampledate))

wq.df <- wq.df %>% 
  select(station, source, sampledate, samplereplicatetype,
         depth, layer, 
         #pycnocline, upperpycnocline, lowerpycnocline,
         parameter, measurevalue) %>% 
  distinct()

wq.df <- wq.df %>% 
  filter(layer == "s", 
         parameter == "chla") %>% 
  unite(parameter, c("layer", "parameter"), remove = FALSE) %>% 
  bind_rows(wq.df)

chla <- wq.df %>%
  filter(parameter=="chla")

#get event.df
events.df <- data.table::fread(file.path(project.dir, "data/phytoplankton2/VA_ODU_phyto_event.csv"
                                         ),
                            data.table = FALSE,
                            na.strings = "")

#get pdepth from event.df
pdepth.df <- events.df %>% 
  filter(layer %in% c("ap", "wc")) %>% 
  mutate(sampledate = as.Date(sampledate)) %>% 
  select(station, sampledate, pdepth) %>% 
  dplyr::distinct()

#filter out below pdepth samples in wq.df
wq.df <- left_join(wq.df, pdepth.df, by = c("station", "sampledate"))
wq.df <- wq.df %>% 
  filter(depth <= pdepth) #%>% 
  
s_chla.df <- wq.df %>%
  filter(parameter=="s_chla")


di_doc.df <- wq.df %>%
  filter(parameter=="doc")

di_chla <- wq.df %>%
  filter(parameter == "chla")

di_salinity <- wq.df %>%
  filter(parameter == "salinity")

di_pheo <- wq.df %>%
  filter(parameter == "pheo")

avg_sal.df <- di_salinity %>%

  group_by(station, sampledate) %>%
  mutate(avg_sal = mean(measurevalue, na.rm = TRUE)) %>%
  ungroup()

avg_salzone.df <- avg_sal.df %>%

  mutate(salzone = case_when(
    measurevalue >0 & measurevalue <= 0.5 ~ "F",
    measurevalue > .5 &  measurevalue <= 5 ~ "O",
    measurevalue > 5 & measurevalue <= 18 ~ "M",
    measurevalue > 18~ "P")
  )
```

```{r}
library(dplyr)
library(readxl)
library(data.table)
library(tidyr)

project.dir <- rprojroot::find_rstudio_root_file()

wq.raw <- data.table::fread(file.path(project.dir, "data/water_quality/cedr_wq.csv"),
                            data.table = FALSE,
                           na.strings = c("")) %>% 
  filter(is.na(problem),
         parameter %in% c("chla", "doc", "pheo", "salinity"))


events.df <- data.table::fread(file.path(project.dir, "data/phytoplankton2/VA_ODU_phyto_event.csv"
                                         ),
                            data.table = FALSE,
                            na.strings = "")

wq.df <- wq.raw %>% 
  mutate(sampledate = as.Date(sampledate))

#3 day prep
events.sub <- events.df %>% 
  select(station, sampledate) %>% 
  distinct() %>% 
  mutate(sampledate = as.Date(sampledate)) %>%
  mutate(lower_date = sampledate - lubridate::days(3),
         upper_date = sampledate + lubridate::days(3))

library(parallel)
n.cores <- detectCores() - 1
cl <- makeCluster(n.cores)
clusterExport(cl = cl, varlist = c("wq.df", "events.sub"))
clusterEvalQ(cl, c(library(dplyr))) %>% invisible()

env.df <- parLapply(cl, 1:nrow(events.sub), function(row.i) {
  
  sub.df <- slice(events.sub, row.i)
  #----------------------------------------------------------------------------
  sub.env <- wq.df %>% 
    filter(station == sub.df$station,
           date >= sub.df$lower_date,
           date <= sub.df$upper_date)
  #----------------------------------------------------------------------------
  if (nrow(sub.env) == 0) return(data.frame(
    station = NA,
    date = NA,
    parameter = NA,
    measurevalue = NA
  ))
  #----------------------------------------------------------------------------
  final.df <- sub.env %>% 
    mutate(date_diff = date - sub.df$sampledate,
           abs_date_diff = abs(date_diff),
           sampledate = sub.df$sampledate) %>% 
    filter(abs_date_diff == min(abs_date_diff))
  #----------------------------------------------------------------------------
  if (nrow(final.df) > 1) {
    final.df <- final.df %>% 
      filter(date == min(date))
  }
  #----------------------------------------------------------------------------
  return(final.df)
}) %>% 
  bind_rows() %>% 
  filter(!is.na(station))

stopCluster(cl)
```

```{r}
library(dplyr)
library(readxl)
library(data.table)
library(tidyr)

project.dir <- rprojroot::find_rstudio_root_file()

wq.raw <- data.table::fread(file.path(project.dir, "data/water_quality/cedr_wq.csv"),
                            data.table = FALSE,
                           na.strings = c("")) %>% 
  filter(is.na(problem),
         parameter %in% c("chla", "doc", "pheo", "salinity"))


events.df <- data.table::fread(file.path(project.dir, "data/phytoplankton2/VA_ODU_phyto_event.csv"
                                         ),
                            data.table = FALSE,
                            na.strings = "")

wq.df <- wq.raw %>% 
  mutate(sampledate = as.Date(sampledate))

wq.df <- wq.df %>% 
  select(station, source, sampledate, samplereplicatetype,
         depth, layer, 
         #pycnocline, upperpycnocline, lowerpycnocline,
         parameter, measurevalue) %>% 
  distinct()

#get pdepth from event.df
pdepth.df <- events.df %>% 
  filter(layer %in% c("ap", "wc")) %>% 
  mutate(sampledate = as.Date(sampledate)) %>% 
  select(station, sampledate, pdepth) %>% 
  dplyr::distinct()

#filter out below pdepth samples in wq.df
wq.df <- left_join(wq.df, pdepth.df, by = c("station", "sampledate"))
wq.df <- wq.df %>% 
  filter(depth <= pdepth) #%>% 

#3 day prep
events.sub <- events.df %>% 
  select(station, sampledate) %>% 
  distinct() %>% 
  mutate(sampledate = as.Date(sampledate)) %>%
  mutate(lower_date = sampledate - lubridate::days(3),
         upper_date = sampledate + lubridate::days(3))

library(parallel)
n.cores <- detectCores() - 1
cl <- makeCluster(n.cores)
clusterExport(cl = cl, varlist = c("wq.df", "events.sub"))
clusterEvalQ(cl, c(library(dplyr))) %>% invisible()

env.df <- parLapply(cl, 1:nrow(events.sub), function(row.i) {
  
  sub.df <- slice(events.sub, row.i)
  #----------------------------------------------------------------------------
  sub.env <- wq.df %>%
    filter(station == sub.df$station,
           date >= sub.df$lower_date,
           date <= sub.df$upper_date)
  
  return(sub.df)
})
```

```{r}
bay.sub <- bay.df %>% 
  select(station, sampledate) %>% 
  distinct() %>% 
  mutate(sampledate = as.Date(sampledate)) %>%
  mutate(lower_date = sampledate - lubridate::days(3),
         upper_date = sampledate + lubridate::days(3))
```

```{r}
foo <- local({x <- 10
             y <- 200
             x +y})

foo

x <- 4

z <- rlang::expr(y <- x * 10)
eval(z)
y


```

```{r}

library(dplyr)


prop_count <- function(df, ...){
  vars_col <- quos(...)
  
  print(vars_col)
  
  df %>% 
    count(!!!vars_col, sort = T) %>% 
    mutate(prop_n = prop.table(n)) %>% 
    mutate(cumsum_n = cumsum(prop_n)) 
}

dplyr::starwars %>% 
  prop_count(homeworld, species)
```
```{r}
var <- 12
range.vec <- c(1:var)
print(range.vec)
```
```{r}
library(dplyr)
set.seed(0)

#Dummy data.frame to test
df <- tbl_df(data.frame(x = rep(1:3, each = 4)))

#Generate the random integer column
df_test = df %>% 
  rowwise() %>%
  mutate(pop=sample(0:1, 1, replace=TRUE))
```

```{r}
# library(dplyr)
# library(readxl)
# library(data.table)
# library(tidyr)
# 
# project.dir <- rprojroot::find_rstudio_root_file()
# 
# event.df <- data.table::fread(file.path(project.dir, "data/phytoplankton2/VA_ODU_phyto_event.csv"
#                                          ),
#                             data.table = FALSE,
#                             na.strings = "")
# 
# 
# test.df <- lapply(1:nrow(event.df), function(row.i)) {
#   
# }

```

```{r}
library(dplyr)

count_var <-  97

id_df <- c(1,2,3,4,5)
var_df <- c(0,0,0,0,0)
my_var <-  c(97,97,97,97,97)
#my_var <- c(100,100,100,100,100)
value_df <- c(0,1,0,1,1)
data.df <- data.frame(id_df,my_var, value_df)


###########  this is it
while((sum(subset(data.df$my_var,value_df !=0)) / as.numeric(nrow(subset(data.df,value_df >0))))<100){

data.df <-data.df %>%
mutate(my_var = case_when( my_var < 100 & value_df >0 ~my_var + 1, TRUE ~ my_var))
}
###########



# rows <-  as.numeric(nrow(subset(data.df,value_df >0)))
# total <- (sum(data.df$my_var) / nrow(data.df - as.numeric(nrow(subset(data.df,value_df >0)))))
# 
# # while((sum(data.df$my_var) / nrow(data.df - nrow(data.df$value.df==0))) <100) {
# apple <- sum(subset(data.df$my_var,value_df !=0)) / as.numeric(nrow(subset(data.df,value_df >0)))# - as.numeric(sum(subset(data.df$my_var,value_df ==0))))
# 
# while((sum(subset(data.df$my_var,value_df !=0)) / as.numeric(nrow(subset(data.df,value_df >0))))<100){
# 
# data.df <-data.df %>%
# mutate(my_var = case_when( my_var < 100 & value_df >0 ~my_var + 1, TRUE ~ my_var))
# }
#while((sum(data.df$my_var) / nrow(data.df - as.numeric(nrow(subset(data.df,value_df ==0))))) <100) {
    # my_var <- my_var + 1
    # print("one more time")
    
    # mutate(my_var = my_var + value_df, count_var <- countvar + case_when(value_df > 0~, TRUE <- 0))
    



```


```{r}
library(dplyr)
library(ggplot2)

project.dir <- rprojroot::find_rstudio_root_file()

dir.create(file.path(project.dir, "data/"),
           recursive = TRUE, showWarnings = FALSE)

#fill in blank with dataframe name
#data.table::fwrite(__________, file.path(project.dir, "data/", "SprBIBI.csv"))



BIBI_plot.df <- data.table::fread(file.path(project.dir, 
                                                 "data/SprBIBI.csv"),
                            data.table = FALSE,
                            #colClasses = col.class.vec,
                            na.strings = "")

BIBI_plot.df <- BIBI_plot.df %>%
  mutate(SITE = as.character(SITE))



plot_df <-BIBI_plot.df %>% group_by(LOCATION) %>%
  do(
    plots =ggplot(data = .) + aes(x = SITE, y = BIBI) +
      geom_boxplot() + ggtitle(.$LOCATION)
  )

plot_df$plots

###############################
counter = 0
for(item in plot_df$plots) {
  counter = counter + 1
  ggsave(filename = paste0("plot",counter), plot = p[[counter]], device= "pdf")
  print(item)
}
##############################

p <- plot_df$plots

p[[1]]
ggsave(filename = paste0("plot",counter), plot = p[[1]], device= "pdf")


#myplot <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
# print(myplot)
# dev.off()

#pdf("plot_df", width = 10)

# 
# BIBI_plot.df <- BIBI_plot.df %>%
#   group_by(LOCATION, SITE) %>%
#   do(ggplot(data = BIBI_plot.df, aes(SITE,BIBI, group = LOCATION))) %>%
#   ungroup()
# 
# ggplot(data = BIBI_plot.df, aes(SITE,BIBI, group = SITE, LOCATION))





# 
# require(reshape2)
# 
# df.m <- melt(plot_df, LOCATION = "Label")





```
this is close to a working version but the random id(iva ave func snippet) is being assigned to values with cumulative above 1.  Don't want that.
```{r}
library(dplyr)


id_df <- c(1,1,1,1,1,2,2,2,2,2)
#var_df <- c(0,0,0,0,0)
cumulative <-  c(66,32,0,0,0,50,48,0,0,0)
#my_var <- c(100,100,100,100,100)
track_order <- c(1:10)
data.df <- data.frame(id_df,cumulative, track_order)


data.df <- data.df %>%
  group_by(id_df) %>%
  mutate(cum_sum = sum(cumulative)) %>%
  mutate(cum_minus_sum = 100-cumulative) %>%
  
  mutate(row_count = n()) %>%
  
  #generates a random id for each member of a grouping
  mutate(g_id = ave(row_count, id_df, FUN=function(x) {sample.int(length(x))})) %>%
  arrange(g_id) %>% #, .by_group = TRUE) %>%
  mutate(value = case_when(g_id <= 100 -cum_sum & cumulative <1 ~1))



```

this is the ongoing attempt to fix the issue
```{r}
library(dplyr)

#count_var <-  97

id_df <- c(1,1,1,1,1,2,2,2,2,2)
#var_df <- c(0,0,0,0,0)
cumulative <-  c(66,32,0,0,0,50,48,0,0,0)
#my_var <- c(100,100,100,100,100)
track_order <- c(1:10)
data.df <- data.frame(id_df,cumulative, track_order)


data.df <- data.df %>%
  group_by(id_df) %>%
  mutate(cum_sum = sum(cumulative)) %>%
  mutate(cum_minus_sum = 100-cumulative) %>%
  
  mutate(row_count = n()) %>%
  ungroup()

data_subset.df <- data.df %>%
  filter(cumulative == 0)
  #generates a random id for each member of a grouping
  
  #mutate(ss_test =subset(data.df$cumulative, cumulative == 0))
  
  #this part needs to apply unique ids to only the subset of the group in which cumulative  == 0, or apply
  #the unique id in a way that differentiates between cum==0 and cum!=0 in a way that makes them iterable
  mutate(g_id = ave(subset(data_subset.df$cumulative, cumulative == 0) , id_df, FUN=function(x) {sample.int(length(x))})) %>%
  arrange(g_id) %>% #, .by_group = TRUE) %>%
  mutate(value = case_when(g_id <= 100 -cum_sum & cumulative <1 ~1))

data_final.df <- left_join(data.df, data_subset.df, by= "unique_id")
  
########

```

```{r}
taxa_test.df <- taxa.df %>% 
  group_by(unique_id) %>%
  mutate(total_sum = sum(reporting_value)) %>%
  mutate(ratio = 100*(reporting_value/total_sum)) %>%
  mutate(ratio = ifelse(ratio >= 1, round(ratio), as.integer(ratio))) %>%
  mutate(cumulative = ifelse(ratio >= 1, sum(ratio), 0)) %>%
  mutate(sum_cum = ifelse(ratio >= 1, 100-cumulative, 100-(max(cumulative)))) %>%
  mutate(count = n()) %>%
```


Chessie BIBI testing code


```{r}
# taxa.df <- prob_rarefaction(taxa.df, unique_id, reporting_value, genus, 100)
```

```{r}
taxa_test.df <- taxa.df %>% 
  group_by(unique_id) %>%
  mutate(total_sum = sum(reporting_value)) %>%
  mutate(ratio = 100*(reporting_value/total_sum)) %>%
  mutate(ratio = ifelse(ratio >= 1, round(ratio), as.integer(ratio))) %>%
  mutate(cumulative = ifelse(ratio >= 1, sum(ratio), 0)) %>%
  mutate(sum_cum = ifelse(ratio >= 1, 100-cumulative, 100-(max(cumulative)))) %>%
  mutate(count = n()) %>%
  rowwise() %>%
  mutate(rc_test =(ifelse(cumulative == 0, sample(0:1, 1, replace=TRUE), ratio))) %>%
  ungroup()

taxa_test.df <- taxa_test.df %>% 
  group_by(unique_id) %>%
  mutate(rc_total = sum(rc_test)) #%>%
  # #for (n()) {
  #   for (sum_cum)}
  # #for cum_sum (mutate(elseif()))
  # summarise(rand = sample_n(.,5))
  
  #mutate(rare_count =ifelse(sum_cum != 100, sample_n(sum_cum), ratio))
```


rowwise() is a stop-gap and not a great one.  This method doesn't work because of that but even if it did it's a brute force and sloppy.
```{r}
taxa_test.df <- taxa.df %>% 
  group_by(unique_id) %>%
  mutate(total_sum = sum(reporting_value)) %>%
  mutate(ratio = 100*(reporting_value/total_sum)) %>%
  mutate(ratio = ifelse(ratio >= 1, round(ratio), as.integer(ratio))) %>%
  mutate(cumulative = ifelse(ratio >= 1, sum(ratio), 0)) %>%
  mutate(sum_cum = ifelse(ratio >= 1, 100-cumulative, 100-(max(cumulative)))) #%>%
```


```{r}
taxa_while_test.df <- taxa_test.df

while((sum(subset(taxa_while_test.df$cumulative,taxa_while_test.df$ratio <1)) / as.numeric(nrow(subset(taxa_while_test.df,taxa_while_test.df$ratio <1))))<100){

taxa_while_test.df <- taxa_while_test.df %>%
mutate(cumulative = case_when( cumulative < 100 & ratio <1 ~cumulative + 1, TRUE ~ cumulative))
}
```



```{r}
  
#   mutate(count = n()) %>%
#   rowwise() %>%
#   mutate(rc_test =(ifelse(cumulative == 0, sample(0:1, 1, replace=TRUE), ratio))) %>%
#   ungroup()
#   
# taxa_test.df <- taxa_test.df %>%
#   mutate(rc_total = sum(rc_test)) %>%
#   while (rc_total != 100) {  
#     rowwise() %>%
#     lapply(mutate(rc_test =(ifelse(cumulative == 0, sample(0:1, 1, replace=TRUE), ratio)))) %>%
#     mutate(rc_total = sum(rc_test))
#     
#   }



```

import, examine, plot, etc. netcdf data from NWM
```{r}
library(ncdf4)
library(raster)
library(sp)

project.dir <- rprojroot::find_rstudio_root_file()

ncdf_path_short <- file.path(project.dir, "data/netcdf/nwm.t00z.short_range.channel_rt.f001.conus.nc")

ncdf_path_long <- file.path(project.dir, "data/netcdf/nwm.t00z.long_range.channel_rt_1.f006.conus.nc")

ncdf_short <- nc_open(ncdf_path_short)
ncdf_long <- nc_open(ncdf_path_long)

print(ncdf_long)
```

```{r}
library(rprojroot)
library(dplyr)
library(ritis)

project.dir <- rprojroot::find_rstudio_root_file()

bay.temp <- data.table::fread(file.path(project.dir, "data/phytoplankton/", "cedr_phyto_taxa.csv")) %>%
  mutate(tsn=as.character(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))

hier.wide <- lapply(unique(bay.temp$org_tsn), function(tsn.i) {
 #print(tsn.i)
  
  if(ncol(usage(tsn.i)) == 0) return(data.frame(org_tsn = as.integer(tsn.i),
                                                stringsAsFactors = FALSE))
  if(!ritis::usage(tsn.i)$taxonUsageRating %in% c("accepted", "valid")) {
    tsn.accepted <- ritis::accepted_names(as.integer(tsn.i))$acceptedTsn
  } else {
    tsn.accepted <- as.integer(tsn.i)
  }
  
  full.df <- ritis::hierarchy_full(tsn.accepted) %>% 
    select(rankname, taxonname, tsn) %>% 
    slice(1:which(tsn == tsn.accepted)) %>% 
    mutate(org_tsn = as.integer(tsn.i),
           final_tsn = as.integer(tsn.accepted),
           final_id = slice(., which(tsn == tsn.accepted))$taxonname)
}) %>% 
  bind_rows() %>% 
  select(-tsn) %>% 
  spread(rankname, taxonname) %>% 
  clean_up()
```

ritis (and lapply)
```{r}
library(rprojroot)
library(dplyr)
library(ritis)

project.dir <- rprojroot::find_rstudio_root_file()

bay.temp <- data.table::fread(file.path(project.dir, "data/CEDR/", "cedr_phyto_taxa.csv")) %>%
  mutate(tsn=as.numeric(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))

accepted <- accepted_names(tsn =  504239, wt="json", raw=FALSE)

#this generates a single match, and the integer 1 is returned
count1 <- any_match_count(504239, wt="json", raw=FALSE)

#this generates zero matches, as expected, and the integer 0 is returned
count2 <- any_match_count(123123123, wt="json", raw=FALSE)

comment_detail(tsn=180543)

tsns <- c(504239,180543,2288,123)

usable <- lapply(tsns, function(tsn.i) {
  usage(tsn.i)$taxonUsageRating
  
  #thing <- ritis::common_names(tsn.i)$commonName
   }) %>% 
  bind_rows()

names <- lapply(tsns, function(tsn.i) {
  common_names(tsn.i)$commonName
  #thing <- ritis::common_names(tsn.i)$commonName
   }) %>% 
  bind_rows()

full <- lapply(tsns, function(tsn.i) {
  hierarchy_full(tsn.i)
  #thing <- ritis::common_names(tsn.i)$commonName
   }) %>% 
  bind_rows()

single_full <- hierarchy_full(2288)
# test.df <- lapply(bay.temp$tsn, function(the_func){
#   mutate(average = mean(the_func))
# })
  #test <- sum(the_func)

```

using taxize
```{r}
library(taxize)
library(ritis)

chiro_tsn <- get_tsn("Chironomus riparius")

green_tsn <- get_tsn("Chlorophyta")

blue_green_tsn <- get_tsn("Cyanobacteria")

zero_test <-  common_names("0")

test_use <- usage("956108")
test_name <- common_names("956108")

test_use2 <- usage("5414")
test_name2 <- common_names("5414")


```


exploring issue with green_cells
```{r}
green_cell_carbon.df <- missing_carbon.df %>%
  filter(latinname=="green_cells") #%>%
  #select(-size)

green_cell_tsn.df <- missing_tsn.df %>%
  filter(latinname=="green_cells") #%>%
  #select(-size)

blue_green_carbon.df <- missing_carbon.df %>%
  filter(latinname=="blue_green_sphere") #%>%
  #select(-size)

blue_green_tsn.df <- missing_tsn.df %>%
  filter(latinname=="blue_green_sphere") #%>%



blue_green_sphere.df <- bay_merged.df %>%
  filter(latinname %in% c("blue_green_sphere","green_cells"))

blue_green_sphere_carbon.df <- carbon.df %>%
  filter(latinname %in% c("green_cells","blue_green_sphere"))

blue_green_sphere_carbon.df <- left_join(blue_green_sphere.df, carbon.df, by= c("latinname","size"))

# bay_w_size.df <- bay_partials_added.df %>%
#   #filter(size != as.character(NA))
#   filter(!size == "not_applicable")


green.df <- left_join(green_cell.df, carbon.df, by= c("latinname"))

chiro <- bay_merged.df %>% filter(latinname %in% c("chironomus_riparius"))

```

no tsn blue_green_sphere but there is tsn for Cyanobacteria.  can this be used instead?  Aslo, check for an alias for green_cells as well.
```{r}
# green_tsn <- get_tsn("Cyanobacteria")
# 
# test <- usage("956108")
# test <- common_names("956108")
# 
# test <- phyto.df %>%
# filter(latinname%in% c("chironomus_riparius","chlorophyta","cryptomonas","green_cells"))
# 
# print(missing_tsn_names <- unique(missing_tsn.df$latinname))
# 
# print(missingcarbon_names <- unique(missing_carbon.df$latinname))
```

```{r}
# c( "green_cells","blue_green_sphere","cylindrospermopsis","woronichinia_naegeliana","limnothrix"            ,"protoperidinium_orbiculare")


```

```{r}
num <- "003402"
nums_fixed <- gsub("(^|[^0-9])0+", "\\1", as.integer(num), perl = TRUE)
```

for Andrea 
```{r}
library(MBSStools)
library(dplyr)

myIndex <- "MBSS.2005.Bugs"

thresh <- MBSStools::metrics_scoring

myMetrics.Bugs.MBSS <- as.character(droplevels(unique(thresh[thresh[,"Index.Name"]==myIndex, "MetricName"])))


testMetric <-  as.character(droplevels(unique(thresh[test, "MetricName"])))
test1 <- #unique(
  thresh[thresh[,"Index.Name"]==myIndex, "Metrics"]#)

test <- thresh[,"Index.Name"]==myIndex
print(typeof(test))
print(test)

```

```{r}
library(readxl)
library(dplyr)


#creates project.dir, phyto directory object 
project.dir <- rprojroot::find_rstudio_root_file()

reservoir.df <- read_excel(file.path(project.dir, "data/Reservoir_Intake_test.xlsx"),
                         sheet = "NorbData"#,
                         #skip = 1
                         )

reservoir.df <-  reservoir.df %>%
  mutate(Id = paste0(Year,Mon)) 

#move last column (id) to first
reservoir.df<-reservoir.df[,c(29, 1:28)]

reservoir.df %>%  
data.table::fwrite(file.path(project.dir, "data/", "Reservoir_intake.csv"))

reservoir.df %>%  
data.table::fwrite(file.path(project.dir, "data/", "Reservoir_intake.xlsx"))

test.df <- reservoir.df %>%
  select(Id, Year, Mon, Res)

test.df %>%  
data.table::fwrite(file.path(project.dir, "data/", "Test.xlsx"))

test.df %>%  
data.table::fwrite(file.path(project.dir, "data/", "Test.csv"))


```


```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)

project.dir <- rprojroot::find_rstudio_root_file()

#import the data
ten_day.df <- data.table::fread(file.path(project.dir, "data/ten_day_test.csv"),
                            data.table = FALSE)

#turn dates to date_time type
ten_day.df$date_time <- as_datetime(as.character(ten_day.df$date_time))
 
#plot the data
ggplot(ten_day.df, aes(x = date_time, y = flow)) + geom_line(aes(linetype = site, colour = site))

#find data with missing flow values
missing.df <- ten_day.df %>%
  dplyr::filter(is.na(flow))
                                
```

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)

project.dir <- rprojroot::find_rstudio_root_file()

#import the data from sarah's site
demands_raw.df <- data.table::fread("https://icprbcoop.org/drupal4/products/coop_pot_withdrawals.csv",
                            data.table = FALSE)

#gather the data into long format
demands.df <- gather(demands_raw.df,site, flow, 2:6)

#turn dates to date_time type
demands.df$DateTime <- as_datetime(as.character(demands.df$DateTime))
 
#plot the data
ggplot(demands.df, aes(x = DateTime, y = flow)) + geom_line(aes(linetype = site, colour = site))

#find data with missing flow values
missing.df <- demands.df %>%
  dplyr::filter(is.na(flow))

```

```{r}
library(RCurl)
test <- url.exists("https://icprbcoop.org/drupal4/products/coop_pot_withdrawals.csv")
print(test)
```

```{r}
library(RCurl)

#site is 
#https://mde.maryland.gov/programs/Water/droughtinformation/Pages/index.aspx

#https://mde.maryland.gov/programs/Water/droughtinformation/Currentconditions/PublishingImages/DroughtGraphsStarting2019jan31/Drought2019-08-31.png

last = 'https://mde.maryland.gov/programs/Water/droughtinformation/Currentconditions/PublishingImages/DroughtGraphsStarting2019jan31/Drought2019-08-31.png' 



# substrRight <- function(x, n){
#   substr(x, nchar(x)-n+1, nchar(x))
# }

# substrRight(x, 6)
# [1] "string"
# 
# substrRight(x, 8)
# [1] "a string"

#grabs the tail end of the address for the Maryland Drought maps last displayed(the date)
last_select = substr(last, nchar(last) -14+1,(nchar(last)-4))

print(last_select)

# makes the date a date object
last_select = as.Date(last_select)

#gets todays date
todays_date = Sys.Date()

#create a vector with all days between today and last date map was updated
dates_array = seq(as.Date(last_select, format="%y-%m-%d"), as.Date(todays_date, format="%y-%m-%d"), by="days")
#dates_array = c(last_select:todays_date)

#print(dates_array[4])

theDate <- last_select +1

test = FALSE


while (theDate <= todays_date && test == FALSE)
{
  url_to_date = (paste0('https://mde.maryland.gov/programs/Water/droughtinformation/Currentconditions/PublishingImages/DroughtGraphsStarting2019jan31/Drought',format(theDate,"20%y-%m-%d"),'.png'))
  
  #https://mde.maryland.gov/programs/Water/droughtinformation/Currentconditions/PublishingImages/DroughtGraphsStarting2019jan31/Drought2019-08-31.png
  
  
  test <- url.exists(url_to_date)
  
  # test <- try(
  #   
  #   url.exists(url_to_date)
  # 
  #   #test =
  #   #download.file(url_to_date, 'url_to_date.png', mode = 'wb')
  #   #return(test)
  # 
  #   # jj <- readPNG('url_to_date.png',native=TRUE)
  #   # plot(0:1,0:1,type="n",ann=FALSE,axes=FALSE)
  #   # rasterImage(jj,0,0,1,1)
  # 
  # )
  #return(test)

  theDate <- theDate + 1                    
}

print(test)
print(url_to_date)

# jj <- readPNG('url_to_date.png',native=TRUE)
# plot(0:1,0:1,type="n",ann=FALSE,axes=FALSE)
# rasterImage(jj,0,0,1,1)

```

```{r}
library(RCurl)
#script to get most recent maryland drought map

#url for maryland map always starts this way
map_url_head = 'https://mde.maryland.gov/programs/Water/droughtinformation/Currentconditions/PublishingImages/DroughtGraphsStarting2019jan31/Drought'

#get todays date
todays_date = Sys.Date()

#set test date variable at todays date
test_date = todays_date

#set a test for if the url we search exists
test = FALSE

#while url searched doesn't produce a valid link to map, until then iterate backwards from todays date
while ( test == FALSE)
{
  #concat to produce url in expected format
  url_to_date = (paste0('https://mde.maryland.gov/programs/Water/droughtinformation/Currentconditions/PublishingImages/DroughtGraphsStarting2019jan31/Drought',format(test_date,"20%y-%m-%d"),'.png'))
  
  #tests if
  test <- url.exists(url_to_date)
  
  #back one day
  test_date = test_date -1
}

print(test)
print(url_to_date)
  

```

```{r}
library(RCurl)
library(stringr)

#script to get most recent virginia drought map


map_url_head ='https://deq1.bse.vt.edu/drought/state/images/maps/'

test <- curl::curl(map_url_head)

open(test)

# Get lines
out <- readLines(test)

#print(out)
#for(i in out[12:15]){print(i)}
#for(i in out[9:length(out)]){print(i)}

#for (i in out[length(out):12]){print(i)}

#get todays date
todays_date = Sys.Date()

str_todays_date = as.character(todays_date)
  #substr(todays_date, nchar(todays_date)-10+1, nchar(todays_date))
print(todays_date)
print(typeof(todays_date))
print(str_todays_date)

#reverse iterate through
#for (i in out[length(out):12]){print(i)}

test_loc <- str_locate(out, str_todays_date)#"2019-09-25") 
#print(test_loc)
# print(out[420:425])
# print(typeof(test))

first <- "imageMapFile"

last <- ".png"

id_num<- str_match(entry2, "imageMapFile(.*?).png")
#print(id_num)
full_url = paste0(map_url_head,id_num[1])#,id_num)
print(full_url)
#print(!is.na(test))
# test1 <- (out[50])
# test2 <- (out[200])
# entry1 <- (out[425])
# entry2 <- (out[426])
# 
# str_sub(entry2, 112,140)
# 
# str_sub(test1, 112,140)
# str_sub(test2, 112,140)


# test2 <- curl::curl(paste0(map_url_head,"imageMapFile1569587611359.png"))
# open(test2)


url = paste0(map_url_head,"imageMapFile1569587611359.png")


#"https://deq1.bse.vt.edu/drought/state/images/maps/imageMapFile1569587611359.png"

```

```{r}
#va drought map continued

library(RCurl)
library(stringr)

map_url_head ='https://deq1.bse.vt.edu/drought/state/images/maps/'

test <- curl::curl(map_url_head)

open(test)
out <- readLines(test)

todays_date = Sys.Date()

test_date = todays_date
str_todays_date = as.character(todays_date)

latest_maps <- vector()

#locate values that match date 
test_loc <- str_locate(out, format(test_date,"20%y-%m-%d"))

#######find 
NonNAindex <- which(!is.na(test_loc))
print(NonNAindex)
# print(out[427:439])
# print(out[5526:5568])
# print(out[19952:19970])
# print(out[19952:19970])
# print(out[20410:20422])
# print(out[25509:25551])
print(out[439])

test = out[427]#[427][168:177])
# print(test)

test_full = out[427:439]
# print(test_full)
#use regex to find the id between known elements
id <- str_match(test,'href=\"(.*?)">imageMapFile')
# print(id[,2])
#assemble the full url
full_url = paste0(map_url_head,id[,2])
# print(full_url)
```

```{r}
library(dplyr)
library(tidyverse)
print(out[2])#5592])

#"<tr><td valign=\"top\"><img src=\"/icons/image2.gif\" alt=\"[IMG]\"></td><td><a href=\"imageMapFile15698691306458.png\">imageMapFile15698691306458.png</a></td><td align=\"right\">2019-09-30 14:45  </td><td align=\"right\"> 31K</td><td>&nbsp;</td></tr>"

#print(NonNAindex)

test.df <- data.frame(matrix(ncol = 4, nrow = length(out)))
cols <- c("html","date", "time", "id")
colnames(test.df) <- cols

test3.df <- as.data.frame(out, row.names = NULL, optional = TRUE, col.names = cols )
colnames(test3.df) <- c("html")

id_pattern = 'href=\"(.*?)">imageMapFile'
date_time_pattern = '"right\">(.*?)  </td><td'
full_pattern = *_([^_]*)

test4.df <- test3.df %>% 
  #mutate(id =str_match(html,'href=\"(.*?)">imageMapFile'))
  extract(test.df, html, c("id", "date_time"), regex = id_pattern)

#cbind(test3.df,date, time, id)


#test2.df <- rbind(test.df, out)
print(test2.df)
#lapply(str_match(out,'>2019-09-30 (.*?)  </td><td'))


# for(i in NonNAindex){
#   print(out[i])
# }


  

# for(i in NonNAindex){
#     id <- str_match(out[i],'>2019-09-30 (.*?)  </td><td')
#     test_vec[i] <- id[,2]
# }

print(test_vec)

```

```{r}
test_url <- "<tr><td valign=\"top\"><img src=\"/icons/image2.gif\" alt=\"[IMG]\"></td><td><a href=\"imageMapFile15698691306458.png\">imageMapFile15698691306458.png</a></td><td align=\"right\">2019-09-30 14:45  </td><td align=\"right\"> 31K</td><td>&nbsp;</td></tr>"


#"href=\".*</a></td><td align=\"right\">*</td><td align=\"right\"> 31K</td><td>&nbsp;</td></tr>"

#"(\\d+).*_([^_]*).xlsx"
pattern_id <- "\\w{10,}"
pattern_date <- "\\d{4}[-]\\d{2}[-]\\d{2}"
pattern_time <- "\\d{2}[:]\\d{2}"

test_out <- str_match(test, pattern_time)
```

```{r}
library(RCurl)
library(stringr)
library(dplyr)
library(tidyverse)

#this is the url that contains all the map files
map_url_head ='https://deq1.bse.vt.edu/drought/state/images/maps/'

#creates an object to open 
test <- curl::curl(map_url_head)

#open and read said object
open(test)
out <- readLines(test)

map.df <- as.data.frame(out, row.names = NULL, optional = TRUE, col.names = cols )
colnames(map.df) <- c("html")

######patterns for finding string fragments for retrieving map
pattern_id <- "(\\d{10,})"
pattern_date <- "(\\d{4}[-]\\d{2}[-]\\d{2})"
pattern_time <- "(\\d{2}[:]\\d{2})"

# pattern_b4_time <- "\\D*[^\\w{10,}]"
# pattern_test <- "(\\d{10,})(\\d{4}[-]\\d{2}[-]\\d{2})(\\d{2}[:]\\d{2})"

################


###this is what you want to do but it's not working as is(look at it tomorow)
#test.df <- extract(map.df,html, c("id","date","time"), regex = pattern_test, remove =FALSE)
id.df <- extract(map.df,html, c("id"), regex = pattern_id)
date.df <- extract(map.df,html, c("date"), regex = pattern_date)
time.df <- extract(map.df,html, c("time"), regex = pattern_time)

maps_full.df <- cbind(map.df,id.df, date.df,time.df)

maps_full.df <- arrange(maps_full.df, desc(date),desc(time))

map_url_id = maps_full.df$id[1]
map_url_date = maps_full.df$date[1]
map_url_time = maps_full.df$time[1]
# print(map_url_id)
# print(map_url_date)
# print(map_url_time)
map_url_full = as.character(paste0(map_url_head,"imageMapFile", map_url_id,".png"))
print(map_url_full)
# maps_full <- left_join(id.df, date.df, by = c("html"))
# maps_full <- left_join(maps_full, time.df, by = c("html"))

# maps_full.df$datetime<- as.character(paste(date.df$date,time.df$time))
# 
# test_maps_full.df <- maps_full.df %>%
#   mutate(datetime = case_when(!is.na(datetime)~ as.POSIXct(datetime), TRUE ~ datetime ))

# Test_maps_full.df <- maps_full.df %>%
#   mutate(datetime = case_when(is.na(datetime)~0) )#, TRUE ~ datetime)


# print (min(maps_full.df$datetime))
# 
# 
# 
# 
# 
# 
# print(head(map2.df$date, 430))
```

