---
title: "Phyto_Shiny"
author: "Luke Vawter"
date: "August 29, 2018"
output: html_document
---

This is a place for general notes as I examine, unpack, and eventually come to understand Zach's R/Shiny code for the Phyto project.

I'm using this process as a way to:
1) learning R markdown
2) improve my understanding of Zach's code
3) practice comprehensive documentation
4) document so I can repeat and others can follow

Directory structure is important for maintainability/ scalability of code.  The three main components of a Shiny app are global, ui and server (making up initial directory branching).  Shiny looks for directories with these names for use.

The current task for the Phyto project is to resolve appendix output.  Current outputs are incorrect.

Below I will play with some R code, included in the Phyto appendix code, that was unfamiliar to me:

```{r}

##this uses a case when structure from dplyr to replicate the structure of an if else control flow structure

x <- sample(1:35,1)
case_when(x > 25 ~ "big",
          x > 15 ~ "medium",
          x > 0 ~ "small")
```


```{r}
library(dplyr)
library(magrittr)

##playing with the mutate

name <- c("tom","jerry")
start_age <- c(12,13)
years_in <- c(3,2)

test.df <- data.frame(name,start_age
  
)
test.df %>%
  mutate(current_age  = start_age + years_in)

print(test.df)

```

note:  mmir, Zach's most recent version of R ibi clacualtion packages, seems to be unavailable for version 3.5.1 of R. Will need to either 1)roll back R 2) push a compatibility change 3)contact Zach.

from stack-overflow:
https://stackoverflow.com/questions/25721884/how-should-i-deal-with-package-xxx-is-not-available-for-r-version-x-y-z-wa

"6. The package is out of date

It may have been archived (if it is no longer maintained and no longer passes R CMD check tests).

In this case, you can load an old version of the package using install_version()

library(remotes)
install_version("foobarbaz", "0.1.2")
An alternative is to install from the github CRAN mirror.

library(remotes)
install_github("cran/foobarbaz")"

__MMIR__ is the Multi-Metric Index R-package built by zachary smith. It is used to calculate "the majority of metrics" in phyto. phyto/notebooks/sections/metric_calc.RMD describes this.
9/18/18 update:  it looks as though MMIR is now working.  devtools::install_github(repo = "InterstateCommissionPotomacRiverBasin/mmir") ..as instructed in getting started section of pibi_notebook (file:///C:/Users/icprbadmin/Downloads/pibi_notebook%20(1).html#validation_of_r-script_calculations)
that worked but needed to install devtools package first.  new errors popped up so go look at those now...


Below is a piece of Zach's code in appendix_a_master.R of Phyto.
it uses paste0 to appends "__l" to each vector element, which is pretty neat.  It's used in creating scores.vec from metrics.vec:
```{r}
metrics.vec <- c("chl_surf", "biomass_chl_ratio", "cyano_biomass", "doc",
                 "pheo", "tot_biomass", "diatom_biomass", "dino_biomass",
                 "prorocentrum_min_abund", "microcystis_aer_abund",
                 "crypto_bio_pct")

scores.vec <- paste0(metrics.vec, "__1")
print(scores.vec)
```

```{r}
library(dplyr)
library(magrittr)

clean_string <- function(x) {
  x %>% 
    stringr::str_trim() %>% 
    tolower() %>% 
    stringr::str_replace_all("\\s+", " ") %>% 
    stringr::str_replace_all(" ", "_") %>%  
    if_else(. == "", as.character(NA), .)
}

clean_up <- function(x) {
  x %>% 
    rename_all(clean_string) %>% 
    mutate_if(is.character, funs(clean_string))%>% 
    distinct()
}


project.dir <- rprojroot::find_rstudio_root_file()

old.org.df <- read_excel(file.path(project.dir, "data/jackie_data/Data 2013_4plus-phyto-metrics.xlsx"),
                         sheet = "DATA_4+biometrics",
                         skip = 1) %>%
  clean_up()

print(old.org.df)
```

After looking at the most recent updates to phyto github it seems the sections Zach was last working on are:

data/Jackie_data/JMJ_Pibi_Salzone_Data.xlsx
../gitignore
data/salzone_8_21.csv

notebook/pibi_calculations.Rmd
notebook/pibi_notebook.Rmd

notebook/rawscripts/extract_notebook_scripts.R
../extracted/...the exctrated outputs:
appendix_a_master.R
conclusions.R
data_acquisition_cedr.R
data_acquisition_itis.R
prep_wq.R
prep_wq_favor_johnson_salzone.R
validation_indepth_metric_assessment.R
validation_metric_disagreement.R

notebook/sections/development/prep_event.Rmd
../prep_wq.Rmd

notebook/section/appendix/:
conclusions.Rmd	
prep_wq_favor_johnson_salzone.Rmd	
summary.Rmd	
validation_indepth_metric_assessment.Rmd	
validation_metric_disagreement.Rmd	
validation_old_values.Rmd	
validation_scoring_disagreement.Rmd


this is the html output of the phyto project
this file is generated from phyto/notebook/pibi_notebook.Rmd
which links all the relevant Rmd files together(try for yourself):
file:///C:/Users/icprbadmin/Downloads/pibi_notebook%20(1).html#appendix_a:_score_comparisons

according to Claire (starting fromt the top of the above document) we have these items yet to run/resolve: 
Appendix A:Score Comparisons
    -Validation of R-Script calculations
    -Import Old Values
    -Modify Old Values
    -IBI Value, IBI Rating, Metric Scoring Disagreements
    -Metric Score Disagreement
    -Calculation of Metric Values from the Raw Data
    -Conclusion
    
    
Zach's custom functions (finally):
-sessionInfo() can generate info needed to replicate the report(as things change in subsequent versions) shows dependency version etc.
-project.dir <- rprojroot::find_rstudio_root_file()
represents phyto project directory(was looking for this for a while)
-clean_up is wrapper for clean_string which does needed formatting of text


The specific area we are looking at in the pibi_notebook is Overview of Discrepancies/IBI Scores.  link is:
file:///C:/Users/icprbadmin/Downloads/pibi_notebook%20(1).html#overview_of_discrepancies

this demonstrates use of clean_up():
```{r}
clean_string <- function(x) {
  x %>% 
    stringr::str_trim() %>% 
    tolower() %>% 
    stringr::str_replace_all("\\s+", " ") %>% 
    stringr::str_replace_all(" ", "_") %>%  
    if_else(. == "", as.character(NA), .)
}

clean_up <- function(x) {
  x %>% 
    rename_all(clean_string) %>% 
    mutate_if(is.character, funs(clean_string))%>% 
    distinct()
}

project.dir <- rprojroot::find_rstudio_root_file()

old.salzone <- readxl::read_excel(file.path(project.dir, "data/jackie_data/JMJ_PIBI_Salzone_Data.xlsx"),
                                  sheet = "COMBINED")#was "JMJ Salzone+Scores"
colnames(old.salzone)

(clean_zone <- clean_up(old.salzone) %>%
    select(latitude, longitude))

```

creating the station vector that contains phyto data.  I think he's establishinga path to pull from the remote source...it's pulling from a json file (fromJSON())
```{r}
library(jsonlite)
url.root <- "http://datahub.chesapeakebay.net/api.JSON"
todays.date <- format(Sys.Date(), "%m-%d-%Y")

station.vec <- file.path(url.root,
                       "LivingResources",
                       "TidalPlankton",
                       "Reported",
                       "1-01-1970",
                       todays.date,
                       "17",
                       "Station") %>% 
  fromJSON() %>% 
  pull(unique(MonitoringLocationId))

print(station.vec)
```

